{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/fetch-wrapper","webpackCompilationHash":"717610f503934bfb8ce8","result":{"data":{"site":{"siteMetadata":{"repoUrl":"https://github.com/giacomocerquone/giacomocerquone.com/tree/master/content/blog","siteUrl":"https://giacomocerquone.com"}},"markdownRemark":{"id":"05f5f8ed-d35b-56db-a3b4-2d6d75f8b463","excerpt":"Hi there, hope you’re enjoying the new website and blog.\nI graduated one month ago and so now that the university’s gone, I hope I’ll have some more time to…","html":"<p>Hi there, hope you’re enjoying the new website and blog.\nI graduated one month ago and so now that the university’s gone, I hope I’ll have some more time to dedicate to my personal stuff including this blog.</p>\n<h2>What is a wrapper</h2>\n<p>We obtain many different results when “wrapping” something: there are wrappers that turns out to be libraries and wrappers that are so small that they’re just an agglomerated amount of code that simplify other’s lives. Mine is one of the second kind.<br>\nI wanted to make this clear because I’ve seen projects like <a href=\"https://github.com/elbywan/wretch\">this</a> that are defined as wrappers but, despite the fact that it has no dependencies included, it has so many features and imposes so much syntax* and structures that it isn’t just a wrapper anymore, but a small lib.</p>\n<p>*<em>For syntax I mean functions and other named components of the lib that implements a pre-defined functionality</em></p>\n<h2>An API “service”</h2>\n<p>In my <a href=\"./aborting-fetch-react-native/\">older post</a> I mentioned of an Api “service” that I’d have share eventually.<br />\n<a href=\"https://gist.github.com/giacomocerquone/61a3b016c1803d44573978c13452989f\">Here</a> you can find the last revision of the code (it’s just a gist) but I won’t assure you to update it since I’m preparing another repo relative to some react native resources and this service will be part of it.</p>\n<p>I started to create my own Api service since the beginning of my work and the first one I used was found on a github repo that I don’t have anymore (not that it’s important since it’s completely changed).\nIt stayed the same for a long time (and it is the same in some old projects) but also for the sake of this article I decided to mutate its syntax and enhance some functionalities.</p>\n<h2>Abortion</h2>\n<p>I wrote the last article about cancellation and abortion of HTTP requests. I sent that article to some people that requested it on a github issue and a guy fixed a little error he spot in my post (it’s about the support for xhr that is, indeed, supported in react native while I thought it wasn’t, <a href=\"https://github.com/facebook/react-native/blob/master/Libraries/Network/XMLHttpRequest.js#L534\">go check yourself</a>).\nIn the meantime support for the AbortController API has <strong>landed in react native 0.60</strong> and so <strong>in this module I’ve also put up an abortion implementation and a working polyfill</strong> for environments that don’t support it (based on the last article’s code).</p>\n<h2>The challenge: defining the api</h2>\n<p>It has been a little bit challenging not implementing it, which <a href=\"https://github.com/jfet97\">jfet</a> helped a bit with his wise advices, but setting the boundaries of the functionalities that this wrapper had to provide and you can observe the pinnacle of these indecisions in the exported “getToken” function which is actually a strange thing considering that you could just import there what you’d set to the getToken (in fact I’ve added a comment about this).</p>\n<p>This is because I wanted to give some basic functionalities but I didn’t want to impose almost anything to the develope since this code is intended to be used knowingly from a developer that <strong>will need to modify it</strong>. Consider like a piece of code you’d see on stackoverflow.</p>\n<h3>How do we return a method to abort the call?</h3>\n<p>This has been the only true challenge. I needed a way to execute the call and at the same time return a method with which the user could abort it.\nI basically started thinking to implement a function to “prepare” a call and then effectively make the call. Something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> promise<span class=\"token punctuation\">,</span> cancel <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> Api<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// and then</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But I wasn’t satisfied with it. I find it too undirected and the promise method is just useless, you can’t pass any new params to that function (nor there was the need) and all that structure was there just to allow me to return a cancel function along with the promise.<br />\nSo I had another idea…</p>\n<h2>The code</h2>\n<p>For brevity I’ll not insert every piece of code, to read it you can go to the gist.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> _toQueryString <span class=\"token operator\">=</span> <span class=\"token operator\">...</span>\n\n<span class=\"token comment\">// EDIT here if you prefer a storage implementation or a store subscription etc.</span>\n<span class=\"token comment\">// you could actually also remove the getToken function and directly call it in the header below</span>\n<span class=\"token keyword\">const</span> methods <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">getToken</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">_makeCancelable</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">promise</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> hasCanceled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> cancelablePromise <span class=\"token operator\">=</span> <span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">_call</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">method<span class=\"token punctuation\">,</span> route<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> setAbortMethod<span class=\"token punctuation\">,</span> auth <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// EDIT you can always strip abortcontroller from here if you need different usages</span>\n  <span class=\"token comment\">// since it can be tricky to handle the cancel function passed to setAbortMethod for specific usage</span>\n  <span class=\"token comment\">// sadly this is the best I could think of</span>\n  <span class=\"token keyword\">const</span> controller <span class=\"token operator\">=</span> AbortController <span class=\"token operator\">?</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AbortController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>method <span class=\"token operator\">===</span> <span class=\"token string\">\"GET\"</span> <span class=\"token operator\">&amp;&amp;</span> params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    route <span class=\"token operator\">+=</span> <span class=\"token function\">_toQueryString</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://jsonplaceholder.typicode.com/\"</span> <span class=\"token operator\">+</span> route<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    method<span class=\"token punctuation\">,</span>\n    headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      Accept<span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>auth <span class=\"token operator\">&amp;&amp;</span> methods<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">{</span> Authorization<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>methods<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// EDIT here based on your api</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>params <span class=\"token operator\">&amp;&amp;</span> method <span class=\"token operator\">!==</span> <span class=\"token string\">\"GET\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">{</span> body<span class=\"token punctuation\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>controller <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">{</span> signal<span class=\"token punctuation\">:</span> controller<span class=\"token punctuation\">.</span>signal <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">currentFetch</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n      <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>ok <span class=\"token operator\">?</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// ERROR handling highly depends on your api</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>controller<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    setAbortMethod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">setAbortMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> controller<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">currentFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> cancelablePromise<span class=\"token punctuation\">,</span> cancel <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">_makeCancelable</span><span class=\"token punctuation\">(</span>currentFetch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    setAbortMethod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">setAbortMethod</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">cancelablePromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PUT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DELETE\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PATCH\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">el</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>methods<span class=\"token punctuation\">[</span>el<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">_call</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> methods<span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Let’s start from the end.</h3>\n<p>I’ve exported an object that contains various methods (collected in the methods object) which one of this is the getToken that allows the developer to instruct the module on how to retrieve the token to pass in the headers.<br />\nYou’d use it like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Api <span class=\"token keyword\">from</span> <span class=\"token string\">\"./api.js\"</span>\nApi<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getToken</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getTokenSelector</span><span class=\"token punctuation\">(</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// example of a redux implementation</span>\n<span class=\"token comment\">// or simply</span>\nApi<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getToken</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token string\">\"token\"</span></code></pre></div>\n<p>Then we bind through an arrow function the five strings (that denote the method property of the fetch option) to one main <code class=\"language-text\">_call</code> method wich will be the handler of all the calls we make.<br />\nThese are the parameters:</p>\n<ul>\n<li><strong>method</strong>: it corresponds to the HTTP methods; you’ll never have access to this param</li>\n<li><strong>route</strong>: the parte after the baseUrl we set after</li>\n<li><strong>params</strong>: an object key value of the params to pass (in get it’ll be converted to query string)</li>\n<li><strong>setAbortMethod</strong>: the function to pass to obtain the abort method, (explanations down below)</li>\n<li><strong>auth</strong>: a flag to manually disable the passing of the token</li>\n</ul>\n<p>The last “auth” param is there to have a more fine-grained control over the headers added for authentication. I’ve encountered APIs that error out if passing a token when one isn’t required and considering that it’s not always convenient to edit or change the result of the getToken function, you can use this flag (it defaults to true).</p>\n<p><strong>Now the _call method</strong>.<br /></p>\n<p>The first thing that <code class=\"language-text\">_call</code> does is to check if the AbortController “constructor” exists. If so it istantiate a controller otherwise the controller gets a <code class=\"language-text\">null</code> value.\nThen we check if the request is a GET request and in that case we build a query string. I decided to not go for the URLSearchParams here since if I don’t wrong in React Native isn’t supported yet.</p>\n<p>We store the full url in the <code class=\"language-text\">url</code> value and then we create the option object of our request. Here is were we pass the controller signal, the params, the token and all the other headers we need.</p>\n<p>We then wrap the fetch in order to postpone the execution of the promise.\nThere is a following check for the existence of the AbortController and:</p>\n<ul>\n<li>if it exists, call the setAbortMethod and then return the unwrapped fetch we wrapped a few lines above</li>\n<li>if it doesn’t exist, we lend the wrapped fetch to the <code class=\"language-text\">_makeCancelable</code> function that is the code analyzed in the last article and proposed by facebook that will return the right promise to await for and the fake cancel method.</li>\n</ul>\n<h3> A note on the setAbortMethod</h3>\n<p>As anticipated earlier I had troubles finding the right way to return back the abort method to the user. The implementation I chose that you can see in the code, produces the following usage:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> cancel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Api<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'someRoute/1'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> cancel <span class=\"token operator\">=</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// awaits the data</span>\n<span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// cancel the request</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>This should be enough to let you get started to use this code. You’ll find more examples in a react ecosystem in a small repo I’m about to prepare and that will be the subject for the next article!</p>","frontmatter":{"slug":"blog/fetch-wrapper","title":"A very simple fetch wrapper ready to use","date":"August 11, 2019","description":"An handy thin fetch wrapper in less of 100 lines featuring abortion (with polyfill for non supporting envs), token setter etc.","image":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHOTRLALF//xAAYEAEBAQEBAAAAAAAAAAAAAAACAQADEP/aAAgBAQABBQJC3XkteamYGU8//8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPwG4Y//EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8BqWv/xAAcEAABAwUAAAAAAAAAAAAAAAABABAhMUFhkaH/2gAIAQEABj8CttGkZaB1/wD/xAAbEAEAAgIDAAAAAAAAAAAAAAABABEhMRBhkf/aAAgBAQABPyGkrZogA8um0Zpr2AcpADi+P//aAAwDAQACAAMAAAAQzA//xAAXEQADAQAAAAAAAAAAAAAAAAAAARFB/9oACAEDAQE/EEzCj//EABcRAAMBAAAAAAAAAAAAAAAAAAABEUH/2gAIAQIBAT8Qa9IP/8QAHBABAQEAAgMBAAAAAAAAAAAAAREAUWEhcYGR/9oACAEBAAE/EKxtkQPvo18EwUH45wEbl8FmljDlNyIkdtzeX93/2Q==","width":900,"height":602,"src":"/static/2855d05531db142f1df313dc0de8814d/2b1a3/wrapped-chocolate.jpg","srcSet":"/static/2855d05531db142f1df313dc0de8814d/2b1a3/wrapped-chocolate.jpg 1x,\n/static/2855d05531db142f1df313dc0de8814d/4dbc7/wrapped-chocolate.jpg 1.5x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"dir":"/fetch-wrapper/fetch-wrapper/","slug":"/blog/fetch-wrapper","previous":{"fields":{"slug":"/blog/aborting-fetch-react-native","dir":"/aborting-fetch-react-native/aborting-fetch-react-native/"},"frontmatter":{"title":"Aborting requests in React Native"}},"next":{"fields":{"slug":"/blog/why-i-dropped-expo-and-embraced-react-native","dir":"/why-i-dropped-expo/why-i-dropped-expo/"},"frontmatter":{"title":"Why I Dropped Expo and embraced React Native"}}}}}